<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<meta charset="UTF-8">
	<head>
		<title>2048 GAME FOR Canvas</title>
		<style type="text/css">
			html {
				-moz-user-select: none;
				-khtml-user-select: none;
				user-select: none;
			}

			body{
				background: #FFE4C4 100%;
			}

			#back_Div {
				width: 480px;
				height:600px;
				margin-left: -240px;
				margin-top: 0px;
				position: absolute;
				left: 50%;
			}

			#header{
				margin: 0;
				width: 100%;
				height: 120px;
			}
			#header > div{
				width: 100px;
				height: 40px;
				padding-top: 3px;
				padding-bottom: 3px;
				background: #8B4726 100%;
	
				border-radius: 5px;
				-webkit-border-radius: 5px;
				-moz-border-radius: 5px;

				font-size: 20px;
				text-align: center;
				cursor: pointer;
			}
			#header #newGame {
				position: absolute;
				top: 64px;
				right: 0px;
			}
			#header #score_Div {
				position: absolute;
				top: 64px;
			}
			#header #score_Div a {
				width: 100%;
				font-size: 10px;
				position: absolute;
				top: 5px;
				left: 0px;
			}
			#header #score_Div #score {
				font-size: 25px;
				position: absolute;
				top: 20px;
			}
			#header #score_Div #scoreAdd {
				position: absolute;
				width: 50%;
				height: 100%;
				top:50%;
				left: 0;
				text-align: center;
				font-size: 20px;
				opacity:0;
			}
			#header #score_Div .start {
				opacity: 0;
				top:50%;
			}
			#header #score_Div .scoreAdd {
				-webkit-animation: moveup 1s 1;
				-o-animation: moveup 1s 1 ;
				animation: moveup 1s 1;
			}
			@keyframes moveup {
				from {
					top: 50%;
					opacity: 0;
				}
				50% {
					opacity: 1;
					top: 0;
				}
				to {
					top: -50%;
					opacity: 0;
				}
			}
			@-webkit-keyframes moveup {
				from {
					top: 50%;
					opacity: 0;
				}
				50% {
					opacity: 1;
					top: 0;
				}
				to {
					top: -50%;
					
					opacity: 0;
				}
			}
			@-moz-keyframes moveup {
				from {
					opacity: 0;
					top: 50%;
				}
				50% {
					opacity: 1;
					top: 0;
				}
				to {
					top: -50%;
					opacity: 0;
				}
			}
			@-o-keyframes moveup {
				from {
					opacity: 0;
					top: 50%;
				}
				50% {
					opacity: 1;
					top: 0;
				}
				to {
					top: -50%;
					opacity: 0;
				}
			}
			
			#contain {
				margin: 0;
				padding-top: 14px; 
				width: 480px;
				height: 456px;
				background: #8B4726 100%;
				border-radius: 10px;
				z-index: 10;
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;

				cursor: default;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;

				overflow: hidden;
			}
			#contain .grid_line:first-child {
				margin-top: 0px;
			}
			#contain .grid_line:last-child {
				margin-bottom: 0px;
			}
			#contain .grid_line {
				margin-top: 14px;
				height: 100px;
				width: 470px;
				clear: both;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
			}
			#contain .grid_line > div {
				width: 100px;
				height: 100px;
				margin-left: 14px;
				display: inline-block;
				background: #C5C1AA 100%;
				border-radius: 5px;
				-webkit-border-radius:5px;
				-moz-border-radius: 5px;

				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
			}
			#contain .cell {
				position: absolute;
				width: 100px;
				height: 100px;
				text-align: center;
				vertical-align: middle;
				
				-webkit-border-radius:5px;
				-moz-border-radius: 5px;
				-ms-border-radius:5px;

				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
			} 
			#contain .cell > div {
				height: 60px;
				font-size: 50px;
				font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
				font-weight: bold;
				text-align: center;
				vertical-align: middle;
				color: #8B5A2B;
				position: relative;
				margin-right: auto;
				margin-left: auto; 
				margin-top: 20px;
			}
			.cellNew {
				-webkit-animation: cellNew 0.5s 1; 
				-moz-animation: cellNew 0.5s 1;
				-ms-animation: cellNew 0.5s 1;
				-o-animation: cellNew 0.5s 1;
			}
			@keyframes cellNew {
				from {
					transform: scale(0.3,0.3);
					-ms-transform: scale(0.3,0.3);
					-o-transform: scale(0.3,0.3); 
					-moz-transform: scale(0.3, 0.3);
					-webkit-transform: scale(0.3,0.3);
				}
				to {

				}
			}
			@-webkit-keyframes cellNew {
				from {
					transform: scale(0.3,0.3);
					-ms-transform: scale(0.3,0.3);
					-o-transform: scale(0.3,0.3); 
					-moz-transform: scale(0.3, 0.3);
					-webkit-transform: scale(0.3,0.3);
				}
				to {

				}
			}
			@-moz-keyframes cellNew {
				from {
					transform: scale(0.3,0.3);
					-ms-transform: scale(0.3,0.3);
					-o-transform: scale(0.3,0.3); 
					-moz-transform: scale(0.3, 0.3);
					-webkit-transform: scale(0.3,0.3);
				}
				to {

				}
			}
			@-o-keyframes cellNew {
				from {
					transform: scale(0.3,0.3);
					-ms-transform: scale(0.3,0.3);
					-o-transform: scale(0.3,0.3); 
					-moz-transform: scale(0.3, 0.3);
					-webkit-transform: scale(0.3,0.3);
				}
				to {

				}
			}

			.cellActive {
				-webkit-animation: cellActive 0.5s 1; 
				-moz-animation: cellActive 0.5s 1;
				-ms-animation: cellActive 0.5s 1;
				-o-animation: cellActive 0.5s 1;
			}
			@keyframes cellActive {
				from {

				}
				to {
					transform: scale(1.1,1.1);
					-ms-transform: scale(1.1,1.1);
					-o-transform: scale(1.1,1.1); 
					-moz-transform: scale(1.1, 1.1);
					-webkit-transform: scale(1.1,1.1);
				}
			}
			@-webkit-keyframes cellActive {
				from {

				}
				to {
					transform: scale(1.1,1.1);
					-ms-transform: scale(1.1,1.1);
					-o-transform: scale(1.1,1.1); 
					-moz-transform: scale(1.1, 1.1);
					-webkit-transform: scale(1.1,1.1);
				}
			}
			@-moz-keyframes cellActive {
				from {

				}
				to {
					transform: scale(1.1,1.1);
					-ms-transform: scale(1.1,1.1);
					-o-transform: scale(1.1,1.1); 
					-moz-transform: scale(1.1, 1.1);
					-webkit-transform: scale(1.1,1.1);
				}
			}
			@-o-keyframes cellActive {
				from {

				}
				to {
					transform: scale(1.1,1.1);
					-ms-transform: scale(1.1,1.1);
					-o-transform: scale(1.1,1.1); 
					-moz-transform: scale(1.1, 1.1);
					-webkit-transform: scale(1.1,1.1);
				}
			}
			#contain .grid-0-0 {
				top: 155px;
				left: 14px;
			}
			#contain .grid-0-1 {
				top: 155px;
				left: 132px;
			}
			#contain .grid-0-2 {
				top: 155px;
				left: 250px;
			}
			#contain .grid-0-3 {
				top: 155px;
				left: 368px;
			}
			#contain .grid-1-0 {
				top: 269px;
				left: 14px;
			}
			#contain .grid-1-1 {
				top: 269px;
				left: 132px;
			}
			#contain .grid-1-2 {
				top: 269px;
				left: 250px;
			}
			#contain .grid-1-3 {
				top: 269px;
				left: 368px;
			}
			#contain .grid-2-0 {
				top: 383px;
				left: 14px;
			}
			#contain .grid-2-1 {
				top: 383px;
				left: 132px;
			}
			#contain .grid-2-2 {
				top: 383px;
				left: 250px;
			}
			#contain .grid-2-3 {
				top: 383px;
				left: 368px;
			}
			#contain .grid-3-0 {
				top: 497px;
				left: 14px;
			}
			#contain .grid-3-1 {
				top: 497px;
				left: 132px;
			}
			#contain .grid-3-2 {
				top: 497px;
				left: 250px;
			}
			#contain .grid-3-3 {
				top: 497px;
				left: 368px;
			}
			#contain .val2 {
				background: #eee4da;
    			box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0), inset 0 0 0 1px rgba(255, 255, 255, 0);
			}
			#contain .val4 {
				background: #ede0c8;
    			box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0), inset 0 0 0 1px rgba(255, 255, 255, 0);
			}
			#contain .val8 {
				color: #f9f6f2;
    			background: #f2b179;
			}
			#contain .val16{
				color: #f9f6f2;
    			background: #f59563;
			}
			#contain .val32 {
				color: #f9f6f2;
    			background: #f67c5f;
			}
			#contain .val64{
			    color: #f9f6f2;
			    background: #f65e3b; 
			}
			 #contain .val128 {
			    color: #f9f6f2;
			    background: #edcf72;
			    box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.2381), inset 0 0 0 1px rgba(255, 255, 255, 0.14286);
			}
			    
  			#contain .val256{
			    color: #f9f6f2;
			    background: #edcc61;
			    box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.31746), inset 0 0 0 1px rgba(255, 255, 255, 0.19048);
    		}
    
  			#contain .val512 {
			    color: #f9f6f2;
			    background: #edc850;
			    box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.39683), inset 0 0 0 1px rgba(255, 255, 255, 0.2381);
    		}
   
  			#contain .val1024 {
			    color: #f9f6f2;
			    background: #edc53f;
			    box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.47619), inset 0 0 0 1px rgba(255, 255, 255, 0.28571);
			    font-size: 40px;
		    }
    
  			#contain .val2048 {
			    color: #f9f6f2;
			    background: #edc22e;
			    box-shadow: 0 0 30px 10px rgba(243, 215, 116, 0.55556), inset 0 0 0 1px rgba(255, 255, 255, 0.33333);
			    font-size: 40px;
			}
 
 			#gameState_Div {
 				z-index: 20;
				margin-top: 0px;
				width: 480px;
				height: 456px;
				background: rgba(205,201,201,0.5);
				border-radius: 10px;
				z-index: 10;

				display: none;
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;

				cursor: default;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
 			}
		</style>
		<script src="jquery.js"></script>
		<script type="text/javascript">

			

			var Start = {
				initCellArray :function(cellNum, callback) {
				/*
				*	argument is one for dimensional size of your two-dimensional Array
				*	you will get the return value as a two-dimensional array
				*/
					var cell = new Array(cellNum);
					for (var i = cellNum - 1; i >= 0; i--) {
						cell[i] = new Array(cellNum);
						for (var j = cellNum -1; j >=0; j--) {
							var cellEle = {
								data : 0,
								active: false,
								isNew: false,
								pos: {
									x:i,
									y:j
								}
							}
							cell[i][j] = cellEle;
							
						}
					};
					callback(cellNum);
					return cell;
				},

			}

			function Game() {
				this.cellNum = 0;
				this.score = 0;

				this.cellMartrix;
				this.scoreLabel;
				this.scoreView;
				this.gameView;

				this.canNewOne = false;

				this.leftPos = [14, 132, 250, 360];
				this.topPos = [155, 269,383, 497];

				this.setGameView = function (view) {
					this.gameView = $(view);
				};
				this.setCell = function (x, y, ok) {
					this.cellMartrix[x][y].data = this.RandomNum();
					this.cellMartrix[x][y].isNew = ok;
				};
				this.setCellMartrix = function () {
					var args = arguments.length;
					console.log('Game.setCellMartrix arguments:'+args);
					if(args == 1) {
						if ((arguments[0]) instanceof Array && (arguments[0])[0] instanceof Array) {
							this.cellMartrix = arguments[0];
						}
						else
							throw new Error('argument for one is not valiable');
					}
					else if(args > 1) {
						var n = 2;
						for (var i = args - 1; i >= 0; i--) {
							if (arguments[i] instanceof Object) {
								
								var x = arguments[i].x;
								var y = arguments[i].y
								if (n == 2) {
									this.cellMartrix[x][y].data = this.RandomNum();
								}else {
									this.cellMartrix[x][y].data = 2;
								}
								n = this.cellMartrix[x][y].data;
								this.cellMartrix[x][y].active = true;
								
							}
						};
					}
				};
				this.getBlankCell = function() {
				/*
				* argument is one for two-dimensional Array like([n][n]) ,the return value is a one-dimensional Array of empty cells
				*/
					var len = this.cellNum;
					var blankCell = new Array();
					var blankNum = 0;
					for (var i = 0;i < len;i++) {
						for (var j = 0;j < len;j++) {
							if (this.cellMartrix[i][j].data == 0) {
								blankCell[blankNum] = this.cellMartrix[i][j];
								//console.log(blankCell[blankNum].pos.x + "," + blankCell[blankNum].pos.y);
								blankNum++;
							}
						}	
					}
					return blankCell;
				};
				this.random = function (n) {
					var rnum = Math.ceil(Math.random()*n) ;
					return rnum;
				};
				this.RandomNum = function () {
					var re = this.random(2)*2;
					return re;
				}
				this.RandomPos = function (array, callback) {//如果传入的是二维数组直接random出来两个点针对游戏刚开始，如果是一个一维数组则传入为剩余空白点的数组
					if (array[0] instanceof Array) {
						var xlen = array.length;
						var ylen = array[0].length;

						var pos1 = {x:0, y:0}, pos2 = {x:0, y:0};

						pos1.x = this.random(xlen)-1;
						pos1.y = this.random(ylen)-1;
						do{
							pos2.x = this.random(xlen)-1;
							pos2.y = this.random(ylen)-1;
								
						}while (pos1.x == pos2.x || pos1.y == pos2.y)

						callback(pos1, pos2);
					}
					else {
						console.log(">>>>"+array.length);
						callback(array[this.random(array.length-1)]);
					}
				};
				this.addPointEvent = function (scoreAdd) {
					this.score += scoreAdd;
					if (scoreAdd) {
						this.scoreView.find('scoreAdd').remove();

						this.scoreView.append('<div id="scoreAdd" class="scoreAdd">+ '
							+scoreAdd
							+'</div>');
					}
					
				};
				this.leftEvent = function (speed) {
					this.canNewOne = false;
					var s = 0
					for (var i = 0;i < this.cellNum;i++) {
						var pre = 0;
						
						for (var j = 0;j < this.cellNum;j++) {
							if (j != pre && this.cellMartrix[i][pre].data == this.cellMartrix[i][j].data) {
								/*
								*合并cell事件
								*/
								if (this.cellMartrix[i][j].data != 0) {
									this.cellMartrix[i][pre].data += this.cellMartrix[i][j].data;
									s = this.cellMartrix[i][pre].data + s;
									this.cellMartrix[i][pre].active = true;
									this.cellMartrix[i][j].data = 0;
									this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]
									},speed, function() {
										/* stuff to do after animation is complete */
										
									});
									this.gameView.find('.grid-'+i+'-'+j).remove();
									this.gameView.find('.grid-'+i+'-'+pre).remove();
									pre++;

									this.canNewOne = true;

								}
							}
							else if (this.cellMartrix[i][j].data != 0 && this.cellMartrix[i][pre].data != this.cellMartrix[i][j].data) {
								if (this.cellMartrix[i][pre].data != 0) {
									pre = pre +1;
									if (pre != j) {
										this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]},
										speed, function() {
										/* stuff to do after animation is complete */
										});
										this.cellMartrix[i][pre].data = this.cellMartrix[i][j].data;
										this.cellMartrix[i][j].data = 0;
										this.canNewOne = true;
									}

									this.gameView.find('.grid-'+i+'-'+j).remove();
								}
								else if (this.cellMartrix[i][pre].data == 0) {
									this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]
									},speed, function() {
										
									});
									this.gameView.find('.grid-'+i+'-'+j).remove();
									this.cellMartrix[i][pre].data = this.cellMartrix[i][j].data;
									this.cellMartrix[i][j].data = 0;
									this.cellMartrix[i][pre].active = false;

									this.canNewOne = true;
								}
							}
							else if (this.cellMartrix[i][j] == 0 && this.cellMartrix[i][pre].data != this.cellMartrix[i][j].data) {

							}
							else {
								this.gameView.find('.grid-'+i+'-'+pre).remove();
							}		
						}
					}
					console.log("s:"+s);
					this.addPointEvent(s);
				};
				this.rightEvent = function (speed) {
					this.canNewOne = false;
					var s =0;
					for (var i = 0;i < this.cellNum;i++) {
						var pre = this.cellNum-1;
						
						for (var j = this.cellNum-1;j >= 0;j--) {
							if (j != pre && this.cellMartrix[i][pre].data == this.cellMartrix[i][j].data) {
								/*
								*合并cell事件
								*/
								if (this.cellMartrix[i][j].data != 0) {
									this.cellMartrix[i][pre].data += this.cellMartrix[i][j].data;
									s += this.cellMartrix[i][pre].data;
									this.cellMartrix[i][pre].active = true;
									this.cellMartrix[i][j].data = 0;
									this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]
									},speed, function() {
										/* stuff to do after animation is complete */
										
									});
									this.gameView.find('.grid-'+i+'-'+j).remove();
									this.gameView.find('.grid-'+i+'-'+pre).remove();
									pre--;

									this.canNewOne = true;
								}
							}
							else if (this.cellMartrix[i][j].data != 0 && this.cellMartrix[i][pre].data != this.cellMartrix[i][j].data) {
								if (this.cellMartrix[i][pre].data != 0) {
									pre = pre -1;
									if (pre != j) {
										this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]},
										speed, function() {
										/* stuff to do after animation is complete */
										});
										this.cellMartrix[i][pre].data = this.cellMartrix[i][j].data;
										this.cellMartrix[i][j].data = 0;
										this.canNewOne = true;
									}
									this.gameView.find('.grid-'+i+'-'+j).remove();
								}
								else if (this.cellMartrix[i][pre].data == 0) {
									this.gameView.find('.grid-'+i+'-'+j).animate({
										opacity: '0.0',
										left: this.leftPos[pre]
									},speed, function() {
										
									});
									this.gameView.find('.grid-'+i+'-'+j).remove();
									this.cellMartrix[i][pre].data = this.cellMartrix[i][j].data;
									this.cellMartrix[i][j].data = 0;
									this.cellMartrix[i][pre].active = false;

									this.canNewOne = true;
								}
							}
							else {
								this.gameView.find('.grid-'+i+'-'+pre).remove();
							}			
						}
					}
					console.log("s:"+s);
					this.addPointEvent(s);
				};
				this.downEvent = function (speed) {
					this.canNewOne = false;
					var s = 0;
					for (var i = 0;i < this.cellNum;i++) {
						var pre = this.cellNum-1;
						
						for (var j = this.cellNum-1;j >= 0;j--) {
							if (j != pre && this.cellMartrix[pre][i].data == this.cellMartrix[j][i].data) {
								/*
								*合并cell事件
								*/
								if (this.cellMartrix[j][i].data != 0) {
									this.cellMartrix[pre][i].data += this.cellMartrix[j][i].data;
									s += this.cellMartrix[pre][i].data;

									this.cellMartrix[pre][i].active = true;
									this.cellMartrix[j][i].data = 0;
									this.gameView.find('.grid-'+j+'-'+i).animate({
										opacity: '0.0',
										top: this.topPos[pre]
									},speed, function() {
										/* stuff to do after animation is complete */
										
									});
									this.gameView.find('.grid-'+j+'-'+i).remove();
									this.gameView.find('.grid-'+pre+'-'+i).remove();
									pre--;

									this.canNewOne = true;

								}
							}
							else if (this.cellMartrix[j][i].data != 0 && this.cellMartrix[pre][i].data != this.cellMartrix[j][i].data) {
								if (this.cellMartrix[pre][i].data != 0) {
									pre = pre -1;
									if (pre != j) {
										this.gameView.find('.grid'+j+'-'+i).animate({
											opacity: '0.0',
											top: this.topPos[pre]},
											speed, function() {
											/* stuff to do after animation is complete */
										});
										this.cellMartrix[pre][i].data = this.cellMartrix[j][i].data;
										this.cellMartrix[j][i].data = 0;
										this.canNewOne = true;
									}
									this.gameView.find('.grid-'+j+'-'+i).remove();
								}
								else if (this.cellMartrix[pre][i].data == 0) {
									this.gameView.find('.grid-'+j+'-'+i).animate({
										opacity: '0.0',
										top: this.topPos[pre]
									},speed, function() {
										
									});
									this.gameView.find('.grid-'+j+'-'+i).remove();
									this.cellMartrix[pre][i].data = this.cellMartrix[j][i].data;
									this.cellMartrix[j][i].data = 0;
									this.cellMartrix[pre][i].active = false;

									this.canNewOne = true;
								}
							}
							else {
								this.gameView.find('.grid-'+pre+'-'+i).remove();
							}			
						}
					}
					console.log("s:"+s);
					this.addPointEvent(s);
				};
				this.upEvent = function (speed) {
					this.canNewOne = false;
					var s = 0;
					for (var i = 0;i < this.cellNum;i++) {
						var pre = 0;
						
						for (var j = 0;j < this.cellNum;j++) {
							if (j != pre && this.cellMartrix[pre][i].data == this.cellMartrix[j][i].data) {
								/*
								*合并cell事件
								*/
								if (this.cellMartrix[j][i].data != 0) {
									this.cellMartrix[pre][i].data += this.cellMartrix[j][i].data;
									s += this.cellMartrix[pre][i].data;

									this.cellMartrix[pre][i].active = true;
									this.cellMartrix[j][i].data = 0;
									this.gameView.find('.grid-'+j+'-'+i).animate({
										opacity: '0.0',
										top: this.topPos[pre]
									},speed, function() {
										/* stuff to do after animation is complete */
									});
									this.gameView.find('.grid-'+pre+'-'+i).remove();
									this.gameView.find('.grid-'+j+'-'+i).remove();
									pre++;

									this.canNewOne = true;
								}
							}
							else if (this.cellMartrix[j][i].data != 0 && this.cellMartrix[pre][i].data != this.cellMartrix[j][i].data) {
								if (this.cellMartrix[pre][i].data != 0) {
									pre = pre +1;
									
									if (pre != j) {
										this.gameView.find('.grid'+j+'-'+i).animate({
											opacity: '0.0',
											top: this.topPos[pre]},
											speed, function() {
											/* stuff to do after animation is complete */
										});
										this.cellMartrix[pre][i].data = this.cellMartrix[j][i].data;
										this.cellMartrix[j][i].data = 0;
										this.canNewOne = true;
									}
									this.gameView.find('.grid-'+j+'-'+i).remove();
		
								}
								else if (this.cellMartrix[pre][i].data == 0) {
									this.gameView.find('.grid-'+j+'-'+i).animate({
										opacity: '0.0',
										top: this.topPos[pre]
									},30, function() {

									});
									this.gameView.find('.grid-'+j+'-'+i).remove();
									this.cellMartrix[pre][i].data = this.cellMartrix[j][i].data;
									this.cellMartrix[j][i].data = 0;
									this.cellMartrix[pre][i].active = false;

									this.canNewOne = true;
								}
							}
							else {
								this.gameView.find('.grid-'+pre+'-'+i).remove();
							}			
						}
					}
					console.log("s:"+s);
					this.addPointEvent(s);
				};
				this.updateView = function () {
					var full = true;
					if(this.cellMartrix instanceof Array && this.cellMartrix[0] instanceof Array) {
						for (var i = 0;i < this.cellNum;i++) {
							for(var j = 0;j < this.cellNum;j++){
								var number = this.cellMartrix[i][j];
								if(!number.data) {
									full = false;
								}
								else {
									if (number.active) {						
										this.gameView.append('<div class="grid-'
											+i+'-'
											+j+' val'
											+number.data+ ' cell cellActive"><div>'
											+number.data+'</div></div>');
										number.active = false;
									}
									else if(number.isNew) {
										this.gameView.append('<div class="grid-'
											+i+'-'
											+j+' val'
											+number.data+' cell cellNew"><div>'
											+number.data+'</div></div>');
										number.isNew = false;
									}
									else 
										this.gameView.append('<div class="grid-'
											+i+'-'
											+j+' val'
											+number.data+' cell"><div>'
											+number.data+'</div></div>');

									if (number.data == 2048) {
										this.Win();
									}
								}
							}
						}
						this.scoreLabel.html(this.score);
						console.log("score:"+this.score);

						if(full) {
							for (var i = this.cellNum - 1; i >= 0; i--) {
								for (var j = this.cellNum - 1; j > 0; j--) {
									if (this.cellMartrix[i][j].data == this.cellMartrix[i][j-1].data){
										console.log('=');
										return;
									}
								};
								for (var k = this.cellNum - 1; k > 0; k--) {
									if (this.cellMartrix[k][i].data == this.cellMartrix[k-1][i].data){
										console.log('=');
										return;
									}
								};
							};
							this.Lose();
						}
					}
					else
						throw new Error("Game.updateView() : cellMartrix is not invaluable");
				};
				this.newOneCell = function (callback) {
					var blankCellArr = this.getBlankCell();
					this.RandomPos(blankCellArr, function (ele) {
						var x = ele.pos.x;
						var y = ele.pos.y;
						console.log("newOneCell:"+x+','+y);
						callback(x, y);
					});

				};
				this.newOneCellCheck = function () {
					
					return this.canNewOne;
				};
				this.EventUtil = {
					addHandler: function (element, type, handler) {
						if (element.addEventListenner){
							element.addEventListenner(type, handler, false);
						}
						else if (element.attachEvent) {
							element.attachEvent(type, handler, false);
						}
						else 
							element["on"+type] = handler;
					},
					removeHandler: function (element, type, handler) {
						if (element.addEventListenner) {
							element.addEventListenner(type, handler, false);
						}
						else if(element.attachEvent) {
							element.attachEvent(type, handler, false);
						}
						else
							element["on"+type] = handler;
					},
					targetIsInput: function (event) {
  						return event.target.tagName.toLowerCase() === "input";
					}
				};
				this.Win = function () {
					alert("win");
				};
				this.Lose = function () {
					alert("lose");
				}
			}

			function outputMartrixTest(martrix, len) {
				for(var i = 0;i < len;i++) {
					for(var j = 0;j< len;j++) {
						console.log('martrix['+i+']['+j+']:' + martrix[i][j].data);
					}
				}
			}

			var TouchEvent = {
				init: function (div, game) {
					this.touch = ("creatTouch" in document);
					this.Start = this.touch ? "toucheStart" : "mousedown";
					this.End = this.touch ? "touchEnd" : "mouseup";
					this.Move;
					this.mainDiv = document.getElementById(div);
					this.bind(game);
				},
				bind: function (game) {
					var x1, x2, y1, y2;
					this.mainDiv["on"+this.Start] = function (e) {
						e.preventDefault();
						var touch = this.touch ? e.touches[0] : e;
						x1 = touch.clientX;
						y1 = touch.clientY;
					}
					this.mainDiv["on" +this.End] = function (e) {
						e.preventDefault();
						var touch = this.touch ? e.touches[0] : e;
						x2 = touch.clientX;
						y2 = touch.clientY;
					

						if (Math.abs(x1-x2) > Math.abs(y1-y2)) {
							//left or right
							if ((x1-x2) < 0) { //right
								game.rightEvent(40);
								if (game.newOneCellCheck())
									game.newOneCell(function (x, y){
										game.setCell(x, y, true);
									});
								game.updateView();
							}
							else if((x1-x2) >0) { //left
								game.leftEvent(40);
								if (game.newOneCellCheck())
									game.newOneCell(function (x, y){
										game.setCell(x, y, true);
									});
								game.updateView();
							}
						}
						else {
									// up or down
							if(y1-y2 > 0) { //up
								game.upEvent(40);
								if (game.newOneCellCheck())
									game.newOneCell(function (x, y){
										game.setCell(x, y, true);
									});
								game.updateView();
							}
							else if (y1-y2 <0){ //down
								game.downEvent(40);
								if (game.newOneCellCheck())
									game.newOneCell(function (x, y){
										game.setCell(x, y, true);
									});
								game.updateView();
								
							}
						}
					}
				}
			};

			(function () {
				$(document).ready(function($) {
					// $('#gameState_Div').hide();
					$('#contain').bind('selectstart', function(event) {
						/* Act on the event */
						return false;
					});
					$('#newGame').bind('selectstart', function (event) {
						return false;
					});

					var newGame = document.getElementById('newGame');

					var game = new Game();

					game.setGameView('#contain');
					game.scoreView = $('#score_Div');
					game.scoreLabel = $('#score');
					game.cellMartrix = Start.initCellArray(4, function (num) {
						game.cellNum = num;
					});
					game.RandomPos(game.cellMartrix, function (pos1, pos2) {
						game.setCellMartrix(pos1, pos2);
					});
					game.updateView();

					TouchEvent.init("contain", game);
					
					game.EventUtil.addHandler(newGame, "click", function (event) {
						game.cellMartrix = Start.initCellArray(4, function (num) {
							game.cellNum = num;
						});
						game.RandomPos(game.cellMartrix, function (pos1, pos2) {
							game.setCellMartrix(pos1, pos2);
						});
						game.gameView.find('.cell').remove();
						game.updateView();
					});

					game.EventUtil.addHandler(window, "keyup", function (event) {

						console.log(event.keyCode);
						if (game.EventUtil.targetIsInput(event)) 
							return;
						if (event.keyCode == '37') { // left
							game.leftEvent(40);
							if (game.newOneCellCheck())
								game.newOneCell(function (x, y){
									game.setCell(x, y, true);
								});
							game.updateView();

						}
						else if (event.keyCode == '38') { // up
							game.upEvent(40);
							if (game.newOneCellCheck())
								game.newOneCell(function (x, y){
									game.setCell(x, y, true);
								});
							game.updateView();

						}
						else if (event.keyCode == '39') { // right
							game.rightEvent(40);
							if (game.newOneCellCheck())
								game.newOneCell(function (x, y){
									game.setCell(x, y, true);
								});
							game.updateView();

						}
						else if (event.keyCode == '40') { // down
							game.downEvent(40);
							if (game.newOneCellCheck())
								game.newOneCell(function (x, y){
									game.setCell(x, y, true);
								});
							game.updateView();
						}
					});
				
				});
			})();

		</script>
	</head>
	<body>
		<div id="back_Div">
			<div id="header">
				<h1>2048 design by Hy</h1>
				<div id="score_Div">
					<a>score:</a>
					<a id="score">0</a>
				</div>
				<div id="newGame">NEW GAME</div>
			</div>
			<div id="contain" >
				<div class="grid_line">
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
				</div>
				<div class="grid_line">
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
				</div>
				<div class="grid_line">
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
				</div>
				<div class="grid_line">
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
					<div onselectstart="return false"></div>
				</div>
			</div>
			<div id="gameState_Div">
				<div id="success_Div">
					
				</div>
				<div id="field_Div">
					<div>You are Lose!!!</div>
					<div>Try Again</div>
				</div>
			</div>
		</div>
	</body>
</html>